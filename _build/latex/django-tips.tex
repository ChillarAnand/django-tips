%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[a5paper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
\edef\sphinxdqmaybe{\ifdefined\DeclareUnicodeCharacterAsOptional\string"\fi}
  \DeclareUnicodeCharacter{\sphinxdqmaybe00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.\@ }}
\makeatletter
\def\fnum@figure{\figurename\thefigure{}}
\makeatother
\addto\captionsenglish{\renewcommand{\tablename}{Table }}
\makeatletter
\def\fnum@table{\tablename\thetable{}}
\makeatother
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}
\addto\captionsenglish{\renewcommand{\sphinxnonalphabeticalgroupname}{Non-alphabetical}}
\addto\captionsenglish{\renewcommand{\sphinxsymbolsname}{Symbols}}
\addto\captionsenglish{\renewcommand{\sphinxnumbersname}{Numbers}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{1}



\title{Django Tips}
\date{Aug 14, 2019}
\release{}
\author{ChillarAnand}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}



\chapter{Automatically Register All Models In Admin}
\label{\detokenize{admin_auto_register_models:automatically-register-all-models-in-admin}}\label{\detokenize{admin_auto_register_models::doc}}
Inbuilt admin interface is one the most powerful \& popular feature of Django. Once we create the models, we need to register them with admin, so that it can read metadata and populate interface for it.

If the django project has too many models or if it has a legacy database, then adding all those models to admin becomes a tedious task. To automate this process, we can programatically fetch all the models in the project and register them with admin.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}


\PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
    \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
\end{sphinxVerbatim}

This works well if we are just auto registering all the models. However if we register some models with admin using custom admin classes and they try to auto register all models in admin.py files in our apps, there will be conflicts as Django doesn’t allow registering the same model twice.

So, we need to make sure this piece of code runs after all admin.py files are loaded and it should ignore models which are already registered. We can safely hook this code in appconfig.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}\PYG{p}{,} \PYG{n}{AppConfig}
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}


\PYG{k}{class} \PYG{n+nc}{CustomApp}\PYG{p}{(}\PYG{n}{AppConfig}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{foo}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{k}{def} \PYG{n+nf}{ready}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
            \PYG{k}{except} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{sites}\PYG{o}{.}\PYG{n}{AlreadyRegistered}\PYG{p}{:}
                \PYG{k}{pass}
\end{sphinxVerbatim}

Now all models will get registed automatically. If we go to a model page in admin, it will just show 1 column like this.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{django-admin-auto}.png}\hspace*{\fill}}

This is not informative for the users who want to see the data. We can create a ListAdminMixin, which will populate list\_display with all the fields in the model. We can create a new admin class which will subclass ListAdminMixin \& ModelAdmin. We can use this admin class when we are registering the model so that all the fields in the model will show up in the admin.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}\PYG{p}{,} \PYG{n}{AppConfig}
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}


\PYG{k}{class} \PYG{n+nc}{ListAdminMixin}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{admin\PYGZus{}site}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{[}\PYG{n}{field}\PYG{o}{.}\PYG{n}{name} \PYG{k}{for} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{\PYGZus{}meta}\PYG{o}{.}\PYG{n}{fields} \PYG{k}{if} \PYG{n}{field}\PYG{o}{.}\PYG{n}{name} \PYG{o}{!=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{id}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{ListAdminMixin}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{admin\PYGZus{}site}\PYG{p}{)}


\PYG{k}{class} \PYG{n+nc}{CustomApp}\PYG{p}{(}\PYG{n}{AppConfig}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{name} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{foo}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{k}{def} \PYG{n+nf}{ready}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
            \PYG{n}{admin\PYGZus{}class} \PYG{o}{=} \PYG{n+nb}{type}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{AdminClass}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ListAdminMixin}\PYG{p}{,} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{admin\PYGZus{}class}\PYG{p}{)}
            \PYG{k}{except} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{sites}\PYG{o}{.}\PYG{n}{AlreadyRegistered}\PYG{p}{:}
                \PYG{k}{pass}
\end{sphinxVerbatim}

Now whenever we create a new model or add a new field to an existing model, it will get reflected in the admin automatically.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{django-admin-auto-2}.png}\hspace*{\fill}}


\chapter{Custom admin actions for individual \& bulk objects}
\label{\detokenize{admin_custom_admin_actions:custom-admin-actions-for-individual-bulk-objects}}\label{\detokenize{admin_custom_admin_actions::doc}}
In the earlier chapters, we have re-registered django auth user model using a proxy model.

Django provides admin actions which work on a queryset level. For example, we can select a bunch of users and delete them.

We can also write custom admin actions to perform other operations. For example, we can write a custom admin action to activate selected users.

These custom admin actions are efficient when we are taking an action on bulk items. For taking a specific action on single item, using custom actions will be inefficient.

For example, to delete a single user, we need to follow these steps.
\begin{quote}

First, we have to select that user record.
Next, we have to click on the action dropdown
Next, we have to select delete action
Next, we have to click Go button.
In the next page we have to confirm that we have to delete.
\end{quote}

Just to delete a single record, we have to perform 5 clicks. That’s too many clicks for a single action.

To simplify the process, we can have delete button at row level. This can be achieved by writing a function which will insert delete button for every record.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{.} \PYG{k+kn}{import} \PYG{n}{models}


\PYG{k}{class} \PYG{n+nc}{ResourceAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
\PYG{k}{def} \PYG{n+nf}{delete}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
\PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}input type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{button}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Delete}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ onclick=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{location.href=}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s1}{/delete/}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{obj}\PYG{o}{.}\PYG{n}{pk}\PYG{p}{)}

    \PYG{n}{delete}\PYG{o}{.}\PYG{n}{allow\PYGZus{}tags} \PYG{o}{=} \PYG{n+nb+bp}{True}
    \PYG{n}{delete}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Delete object}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}  \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{url}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{delete}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{models}\PYG{o}{.}\PYG{n}{Book}\PYG{p}{)}
\end{sphinxVerbatim}

Now we have an admin with delete button for the records.

To delete an object, just click on delete button and then confirm to delete it. Now, we are deleting objects with just 2 clicks.

We can also have buttons with custom actions. For example, we can add a button which will toggle the active status of an user.

\begin{sphinxVerbatim}[commandchars=\\\{\}]

\end{sphinxVerbatim}

In this chapter, we have seen how to write custom admin actions which work on single item as well as bulk items.


\chapter{Hyperlink Foreignkeys To Its Change View In Admin}
\label{\detokenize{admin_hyperlink_foreignkey:hyperlink-foreignkeys-to-its-change-view-in-admin}}\label{\detokenize{admin_hyperlink_foreignkey::doc}}
Consider Book model which has Author as foreignkey.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.db} \PYG{k+kn}{import} \PYG{n}{models}


\PYG{k}{class} \PYG{n+nc}{Author}\PYG{p}{(}\PYG{n}{models}\PYG{o}{.}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{name} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Book}\PYG{p}{(}\PYG{n}{models}\PYG{o}{.}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{title} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{author} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{Author}\PYG{p}{)}
\end{sphinxVerbatim}

We can register these models with admin interface as follows.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{.models} \PYG{k+kn}{import} \PYG{n}{Author}\PYG{p}{,} \PYG{n}{Book}

\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Author}\PYG{p}{)}
\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Book}\PYG{p}{,} \PYG{n}{BookAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

Once they are registed, admin page shows Book model like this.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{django-admin-fk-link-1}.png}\hspace*{\fill}}

While browsing books, we can see book name and author name. Here, book name field is liked to book change view. But author field is shown as plain text.

If we have to modify author name, we have to go back to authors admin page, search for relevant author and then change name.

This becomes tedious if users spend lot of time in admin for tasks like this. Instead, if author field is hyperlinked to author change view, we can directly go to that page and change the name.

Django provides an option to access admin views by its URL reversing system. For example, we can get change view of author model in book app using reverse(“admin:book\_author\_change”, args=id). Now we can use this url to hyperlink author field in book admin.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}
\PYG{k+kn}{from} \PYG{n+nn}{django.utils.safestring} \PYG{k+kn}{import} \PYG{n}{mark\PYGZus{}safe}


\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author\PYGZus{}link}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{author\PYGZus{}link}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{book}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{url} \PYG{o}{=} \PYG{n}{reverse}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{admin:book\PYGZus{}author\PYGZus{}change}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{args}\PYG{o}{=}\PYG{p}{[}\PYG{n}{book}\PYG{o}{.}\PYG{n}{author}\PYG{o}{.}\PYG{n}{id}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{link} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}a href=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZgt{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s1}{\PYGZlt{}/a\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n}{book}\PYG{o}{.}\PYG{n}{author}\PYG{o}{.}\PYG{n}{name}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mark\PYGZus{}safe}\PYG{p}{(}\PYG{n}{link}\PYG{p}{)}
    \PYG{n}{author\PYGZus{}link}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Author}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Now in the book admin view, author field will be hyperlinked to its change view and we can visit just by clicking it.

Depending on requirements, we can link any field in django to other fields or add custom fields to improve productivity of users in admin.


\chapter{Allow ForeignKey Fields In Admin List Display}
\label{\detokenize{admin_list_display_foreignkey:allow-foreignkey-fields-in-admin-list-display}}\label{\detokenize{admin_list_display_foreignkey::doc}}
Django admin has \sphinxtitleref{ModelAdmin} class which provides options and functionality for the models in admin interface. It has options like \sphinxtitleref{list\_display}, \sphinxtitleref{list\_filter}, \sphinxtitleref{search\_fields} to specify fields for corresponding actions.

\sphinxtitleref{search\_fields}, \sphinxtitleref{list\_filter} and other options allow to include a ForeignKey or ManyToMany field with lookup API follow notation. For example, to search by book name in Bestselleradmin, we can specify \sphinxtitleref{book\_\_name} in search fields.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{BestSeller}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{search\PYGZus{}fields} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Bestseller}\PYG{p}{,} \PYG{n}{BestsellerAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

However Django doesn’t allow the same follow notation in \sphinxtitleref{list\_display}. To include ForeignKey field or ManyToMany field in the list display, we have to write a custom method and add this method in list display.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{BestSeller}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{search\PYGZus{}fields} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{author}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{book}\PYG{o}{.}\PYG{n}{author}
    \PYG{n}{author}\PYG{o}{.}\PYG{n}{description} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Author}\PYG{l+s+s1}{\PYGZsq{}}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Bestseller}\PYG{p}{,} \PYG{n}{BestsellerAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

This way of adding foreignkeys in list\_display becomes tedious when there are lots of models with foreignkey fields.

We can write a custom admin class to dynamically set the methods as attributes so that we can use the ForeignKey fields in list\_display.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}related\PYGZus{}field}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{admin\PYGZus{}order\PYGZus{}field}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{short\PYGZus{}description}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{related\PYGZus{}names} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{dynamic\PYGZus{}attribute}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{related\PYGZus{}name} \PYG{o+ow}{in} \PYG{n}{related\PYGZus{}names}\PYG{p}{:}
            \PYG{n}{obj} \PYG{o}{=} \PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{,} \PYG{n}{related\PYGZus{}name}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{obj}

    \PYG{n}{dynamic\PYGZus{}attribute}\PYG{o}{.}\PYG{n}{admin\PYGZus{}order\PYGZus{}field} \PYG{o}{=} \PYG{n}{admin\PYGZus{}order\PYGZus{}field} \PYG{o+ow}{or} \PYG{n}{name}
    \PYG{n}{dynamic\PYGZus{}attribute}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{n}{short\PYGZus{}description} \PYG{o+ow}{or} \PYG{n}{related\PYGZus{}names}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{replace}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{dynamic\PYGZus{}attribute}


\PYG{k}{class} \PYG{n+nc}{RelatedFieldAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}getattr\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{attr}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{get\PYGZus{}related\PYGZus{}field}\PYG{p}{(}\PYG{n}{attr}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} not dynamic lookup, default behaviour}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}getattribute\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{attr}\PYG{p}{)}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

By sublcassing RelatedFieldAdmin, we can directly use foreignkey fields in list display.

However, this will lead to N+1 problem. We will discuss more about this and how to fix this in orm optimizations chapter.


\chapter{Finding High-impact Performance Bottlenecks}
\label{\detokenize{misc_bottlenecks:finding-high-impact-performance-bottlenecks}}\label{\detokenize{misc_bottlenecks::doc}}
When optimizing performance of web application, a common mistake is to start with optimizing the slowest page(or API). In addition to considering response time, we should also consider the traffic it is receving to priorotize the order of optimization.

In this article we will profile a django webapp, find high-impact performance bottlenecks and then start optimization them to yield better performance.
Profiling

django-silk is an open source profiling tool which intercepts and stores HTTP requests data. Install it with pip.

pip install django-silk

Add silk to installed apps and include silk middleware in django settings.
\begin{description}
\item[{MIDDLEWARE = {[}}] \leavevmode
…
‘silk.middleware.SilkyMiddleware’,
…

\end{description}

{]}
\begin{description}
\item[{INSTALLED\_APPS = (}] \leavevmode
…
‘silk’

\end{description}

)

Run migrations so that Silk can create required database tables to store profile data.

\$ python manage.py makemigrations
\$ python manage.py migrate
\$ python manage.py collectstatic

Include silk urls in root urlconf to view the profile data.

urlpatterns += {[}url(r’\textasciicircum{}silk/’, include(‘silk.urls’, namespace=’silk’)){]}

On silk requests page(\sphinxurl{http://host/silk/requests/}), we can see all requests and sort them by overall time or time spent in database.

High Impact Bottlenecks

Silk creates silk\_request table which contains information about the requests processed by django.

\$ pgcli

library\textgreater{} d silk\_request;

…

We can group these requests data by path, calculate number of requests, average time taken and impact factor of each path. Since we are considering response time and traffic, impact factor will be product of average response time and number of requests for that path.
\begin{description}
\item[{library\textgreater{} SELECT}] \leavevmode\begin{quote}

s.*, round((s.avg\_time * s.count)/max(s.avg\_time*s.count) over ()::NUMERIC,2) as impact
\end{quote}
\begin{description}
\item[{FROM}] \leavevmode
(select path, round(avg(time\_taken)::numeric,2) as avg\_time, count(path) as count from silk\_request group by PATH)
s

\end{description}

ORDER BY impact DESC;

\end{description}

…

We can see /point/book/book/ has highest impact even though it is neighter most visited nor slowest view. Optimizing this view first yields in overall better performance of webapp.
Conclusion

In this article, we learnt how to profile django webapp and identify bottlenecks to improve performance. In the next article, we wil learn how to optimize these bottlenecks by taking an in-depth look at them.

paas

iaas

ec2

home


\chapter{Dynamic Initial Values In Forms}
\label{\detokenize{misc_gotcha_initial:dynamic-initial-values-in-forms}}\label{\detokenize{misc_gotcha_initial::doc}}
Django form fields accept initial argument. So You can set a default value for a field.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{SampleForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}     \PYG{n}{name} \PYG{o}{=} \PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{initial}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{avil page}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f} \PYG{o}{=} \PYG{n}{SampleForm}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+sa}{u}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{avil page}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Sometimes it is required to override init method in forms and set field initial arguments.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{initial} \PYG{o}{=}  \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f2} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f2}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Now let’s pass some initial data to form and see what happens.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{initial} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} don\PYGZsq{}t try this at home}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{19}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f3} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{n}{initial}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f3}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

If You look at the value of input field, it’s is NOT the overrided. It still has form initial value!

If You look into source code of django forms to find what is happening, You will find this.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{data} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{field}\PYG{o}{.}\PYG{n}{bound\PYGZus{}data}\PYG{p}{(}
       \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data}\PYG{p}{,}
       \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{form}\PYG{o}{.}\PYG{n}{initial}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{field}\PYG{o}{.}\PYG{n}{initial}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} precedence matters!!!!}
\PYG{p}{)}
\end{sphinxVerbatim}

So form’s initial value has precedence over fields initial values.

So You have to override form’s initial value instead of fields’s initial value to make it work as expected.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{21}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{22}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{initial}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} aha!!!!}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{23}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f4} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{n}{initial}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f4}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Management command
intial value

models initial value
dict=\{\}


\chapter{Management commands}
\label{\detokenize{misc_management_commands:management-commands}}\label{\detokenize{misc_management_commands::doc}}
ram
.iterator()

cpu
cron job
frequent restarts


\chapter{Automatically Set CSRF Token in Postman}
\label{\detokenize{misc_postman_csrf_token:automatically-set-csrf-token-in-postman}}\label{\detokenize{misc_postman_csrf_token::doc}}
Django has inbuilt CSRF protection mechanism for requests via unsafe methods to prevent Cross Site Request Forgeries. When CSRF protection is enabled on AJAX POST methods, X-CSRFToken header should be sent in the request.

Postman is one of the widely used tool for testing APIs. In this article, we will see how to set csrf token and update it automatically in Postman.
CSRF Token In Postman

Django sets csrftoken cookie on login. After logging in, we can see the csrf token from cookies in the Postman.

We can grab this token and set it in headers manually.

But this token has to be manually changed when it expires. This process becomes tedious to do it on an expiration basis.

Instead, we can use Postman scripting feature to extract token from cookie and set it to an environment variable. In Test section of postman, add these lines.

var xsrfCookie = postman.getResponseCookie(“csrftoken”);
postman.setEnvironmentVariable(‘csrftoken’, xsrfCookie.value);

This extracts csrf token and sets it to an evironment variable called csrftoken in the current environment.

Now in our requests, we can use this variable to set the header.

When the token expires, we just need to login again and csrf token gets updated automatically.
Conclusion

In this article we have seen how to set and renew csrftoken automatically in Postman. We can follow similar techniques on other API clients like CURL or httpie to set csrf token.

Django Tips \& Tricks \#7 - Django Auth Plugin For HTTPie

HTTPie is an alternative to curl for interacting with web services from CLI. It provides a simple and intuitive interface and it is handy to send arbitrary HTTP requests while testing/debugging APIs.

When working with web applications that require authentication, using httpie is difficult as authentication mechanism will be different for different applications. httpie has in built support for basic \& digest authentication.

To authenticate with Django apps, a user needs to make a GET request to login page. Django sends login form with a CSRF token. User can submit this form with valid credentials and a session will be initiated.

Establish session manually is boring and it gets tedious when working with multiple apps in multiple environments(development, staging, production).

I have written a plugin called httpie-django-auth which automates django authentication. It can be installed with pip

pip install httpie-django-auth

By default, it uses /admin/login to login. If you need to use some other URL for logging, set HTTPIE\_DJANGO\_AUTH\_URL environment variable.

export HTTPIE\_DJANGO\_AUTH\_URL=’/accounts/login/’

Now you can send authenticated requests to any URL as

http :8000/profile -A=django \textendash{}auth=’username:password’


\chapter{Profiling slowest parts of dango}
\label{\detokenize{misc_profiling:profiling-slowest-parts-of-dango}}\label{\detokenize{misc_profiling::doc}}
./manage.py runcprofileserver


\chapter{Useful Shell Aliases For Python/Django Developers}
\label{\detokenize{misc_shell_aliases:useful-shell-aliases-for-python-django-developers}}\label{\detokenize{misc_shell_aliases::doc}}
Developers and hackers prefer using terminal and spend a lot of time on it. Instead of typing long commands over and over, they can be aliased to shortnames. The shell builtin alias allows users to set aliases.

One of the most used command while setting up development environment is pip install -r requirements.txt This can be aliased to pir.

alias pir=’pip install -r requirements.txt
Now to install requirements, type pir and pressing enter. Here are some other aliases related to python which will be useful on a daily basis.

alias py=’python’
alias ipy=’ipython’
alias py3=’python3’
alias ipy3=’ipython3’

alias jn=’jupyter notebook’

alias wo=’workon’
alias pf=’pip freeze \textbar{} sort’
alias pi=’pip install’
alias pun=’pip uninstall’

alias dj=”python manage.py”
alias drs=”python manage.py runserver”
alias drp=”python manage.py runserverplus”
alias dsh=”python manage.py shell”
alias dsp=”python manage.py shell\_plus”
alias dsm=”python manage.py schemamigration”
alias dm=”python manage.py migrate”
alias dmm=”python manage.py makemigrations”
alias ddd=”python manage.py dumpdata”
alias dld=”python manage.py loaddata”
alias dt=”python manage.py test”
Just add the above aliases to your \textasciitilde{}/.bashrc or \textasciitilde{}/.zshrc. That’s it. Hpy alsng!

command-line django django-tips-tricks python
Previous post Next post
\begin{quote}

Written by
\end{quote}

Chillar Anand
Musings about programming, careers \& life.
Comments

Contents © 2019 Chillar Anand - Powered by Nikola


\chapter{Log SQL Queries To Console}
\label{\detokenize{orm_log_sql:log-sql-queries-to-console}}\label{\detokenize{orm_log_sql::doc}}
Django ORM makes easy to interact with database. To understand what is happening behing the scenes or to see SQL performance, we can log all the SQL queries that be being executed. In this article, we will see various ways to achieve this.


\section{Using debug-toolbar}
\label{\detokenize{orm_log_sql:using-debug-toolbar}}
Django debug toolbar provides panels to show debug information about requests. It has SQL panel which shows all executed SQL queries and time taken for them.

When building REST APIs or micro services where django templating engine is not used, this method won’t work. In these situations, we have to log SQL queries to console.


\section{Using django-extensions}
\label{\detokenize{orm_log_sql:using-django-extensions}}
Django-extensions provides lot of utilities for productive development. For runserver\_plus and shell\_plus commands, it accepts and optional \textendash{}print-sql argument, which prints all the SQL queries that are being executed.

./manage.py runserver\_plus \textendash{}print-sql
./manage.py shell\_plus \textendash{}print-sql
Whenever an SQL query gets executed, it prints the query and time taken for it in console.

In {[}42{]}: User.objects.filter(is\_staff=True)
Out{[}42{]}: SELECT “auth\_user”.”id”,
\begin{quote}
\begin{quote}
\begin{quote}

“auth\_user”.”password”,
“auth\_user”.”last\_login”,
“auth\_user”.”is\_superuser”,
“auth\_user”.”username”,
“auth\_user”.”first\_name”,
“auth\_user”.”last\_name”,
“auth\_user”.”email”,
“auth\_user”.”is\_staff”,
“auth\_user”.”is\_active”,
“auth\_user”.”date\_joined”
\end{quote}

FROM “auth\_user”
\end{quote}

WHERE “auth\_user”.”is\_staff” = true
LIMIT 21
\end{quote}

Execution time: 0.002107s {[}Database: default{]}

\textless{}QuerySet {[}\textless{}User: anand\textgreater{}, \textless{}User: chillar\textgreater{}{]}\textgreater{}
Using django-querycount
Django-querycount provides a middleware to show SQL query count and show duplicate queries on console.

{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
\textbar{} Type \textbar{} Database  \textbar{}   Reads  \textbar{}  Writes  \textbar{}  Totals  \textbar{} Duplicates \textbar{}
{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
\textbar{} RESP \textbar{}  default  \textbar{}    3     \textbar{}    0     \textbar{}    3     \textbar{}     1      \textbar{}
{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
Total queries: 3 in 1.7738s

Repeated 1 times.
SELECT “django\_session”.”session\_key”,
“django\_session”.”session\_data”, “django\_session”.”expire\_date” FROM
“django\_session” WHERE (“django\_session”.”session\_key” =
‘dummy\_key AND “django\_session”.”expire\_date”
\textgreater{} ‘2018-05-31T09:38:56.369469+00:00’::timestamptz)
This package provides additional settings to customize output.

Django logging
Instead of using any 3rd party package, we can use django.db.backends logger to print all the SQL queries.

Add django.db.backends to loggers list and set log level and handlers.
\begin{quote}
\begin{description}
\item[{‘loggers’: \{}] \leavevmode\begin{description}
\item[{‘django.db.backends’: \{}] \leavevmode
‘level’: ‘DEBUG’,
‘handlers’: {[}‘console’, {]},

\end{description}

\},

\end{description}
\end{quote}

In runserver console, we can see all SQL queries that are being executed.

(0.001) SELECT “django\_admin\_log”.”id”, “django\_admin\_log”.”action\_time”, “django\_admin\_log”.”user\_id”, “django\_admin\_log”.”content\_type\_id”, “django\_admin\_log”.”object\_id”, “django\_admin\_log”.”object\_repr”, “django\_admin\_log”.”action\_flag”, “django\_admin\_log”.”change\_message”, “auth\_user”.”id”, “auth\_user”.”password”, “auth\_user”.”last\_login”, “auth\_user”.”is\_superuser”, “auth\_user”.”username”, “auth\_user”.”first\_name”, “auth\_user”.”last\_name”, “auth\_user”.”email”, “auth\_user”.”is\_staff”, “auth\_user”.”is\_active”, “auth\_user”.”date\_joined”, “django\_content\_type”.”id”, “django\_content\_type”.”app\_label”, “django\_content\_type”.”model” FROM “django\_admin\_log” INNER JOIN “auth\_user” ON (“django\_admin\_log”.”user\_id” = “auth\_user”.”id”) LEFT OUTER JOIN “django\_content\_type” ON (“django\_admin\_log”.”content\_type\_id” = “django\_content\_type”.”id”) WHERE “django\_admin\_log”.”user\_id” = 4 ORDER BY “django\_admin\_log”.”action\_time” DESC LIMIT 10; args=(4,)
{[}2018/06/03 15:06:59{]} HTTP GET /admin/ 200 {[}1.69, 127.0.0.1:47734{]}
These are few ways to log all SQL queries to console. We can also write a custom middleware for better logging of these queries and get some insights.


\chapter{ORM Optimizations}
\label{\detokenize{orm_optimizations:orm-optimizations}}\label{\detokenize{orm_optimizations::doc}}
N+1 Queries

book.author.id
book.author\_id

qs.exist()

.iterator()

bulk operations

bulk update wont call save or signals

get only what you need

values\_list()

enable query logging



\renewcommand{\indexname}{Index}
\printindex
\end{document}