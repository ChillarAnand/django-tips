%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,12pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\usepackage[paperwidth=7.0in, paperheight=9.2in, bindingoffset=0.2in,left=1in,right=1in,top=1in,bottom=0.75in,footskip=.25in]{geometry}
\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
\edef\sphinxdqmaybe{\ifdefined\DeclareUnicodeCharacterAsOptional\string"\fi}
  \DeclareUnicodeCharacter{\sphinxdqmaybe00A0}{\nobreakspace}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2500}{\sphinxunichar{2500}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2502}{\sphinxunichar{2502}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2514}{\sphinxunichar{2514}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe251C}{\sphinxunichar{251C}}
  \DeclareUnicodeCharacter{\sphinxdqmaybe2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}
\usepackage{times}
\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}

\addto\captionsenglish{\renewcommand{\figurename}{Fig.\@ }}
\makeatletter
\def\fnum@figure{\figurename\thefigure{}}
\makeatother
\addto\captionsenglish{\renewcommand{\tablename}{Table }}
\makeatletter
\def\fnum@table{\tablename\thetable{}}
\makeatother
\addto\captionsenglish{\renewcommand{\literalblockname}{Listing}}

\addto\captionsenglish{\renewcommand{\literalblockcontinuedname}{continued from previous page}}
\addto\captionsenglish{\renewcommand{\literalblockcontinuesname}{continues on next page}}
\addto\captionsenglish{\renewcommand{\sphinxnonalphabeticalgroupname}{Non-alphabetical}}
\addto\captionsenglish{\renewcommand{\sphinxsymbolsname}{Symbols}}
\addto\captionsenglish{\renewcommand{\sphinxnumbersname}{Numbers}}

\addto\extrasenglish{\def\pageautorefname{page}}

\setcounter{tocdepth}{1}

\usepackage{lastpage}
\usepackage{fancyhdr}

\pagestyle{fancy}
\fancyhf{}
\cfoot{\thepage\ of \pageref{LastPage}}


%% \usepackage[a5paper,bindingoffset=0.2in,%
%%             left=1in,right=1in,top=1in,bottom=1in,%
%%             footskip=.25in]{geometry}


\title{Django Tips}
\date{Aug 19, 2019}
\release{}
\author{ChillarAnand}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}



\chapter{Preface}
\label{\detokenize{preface:preface}}\label{\detokenize{preface::doc}}

\section{Why this book?}
\label{\detokenize{preface:why-this-book}}
blog posts


\section{Who should read this book?}
\label{\detokenize{preface:who-should-read-this-book}}
users


\section{Acknowlodgements}
\label{\detokenize{preface:acknowlodgements}}
Krace Kumar

Haris Ibrahim

Tim Graham,https://techytim.com/

Andrew Godwin, \sphinxurl{http://www.aeracode.org/}

Haki Banita

\sphinxurl{https://hakibenita.com/}


\chapter{Auto Register All Models In Admin}
\label{\detokenize{admin_auto_register_models:auto-register-all-models-in-admin}}\label{\detokenize{admin_auto_register_models::doc}}

\section{Manual Registration}
\label{\detokenize{admin_auto_register_models:manual-registration}}
Inbuilt admin interface is one the most powerful \& popular feature of Django. Once we create the models, we need to register them with admin, so that it can read schema and populate interface for it.

Let us register Book model in the admin interface.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} file: library/book/admin.py}

\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{Book}


\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Book}\PYG{p}{,} \PYG{n}{BookAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

Now, we can see the book model in admin.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-auto-register1}.png}\hspace*{\fill}}

If the django project has too many models to be registered in admin or if it has a legacy database where all tables need to be registered in admin, then adding all those models to admin becomes a tedious task.


\section{Auto Registration}
\label{\detokenize{admin_auto_register_models:auto-registration}}
To automate this process, we can programatically fetch all the models in the project and register them with admin. Also, we need to ignore models which are already registered with admin as django doesn’t allow regsitering same model twice.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}


\PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
    \PYG{k}{except} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{sites}\PYG{o}{.}\PYG{n}{AlreadyRegistered}\PYG{p}{:}
        \PYG{k}{pass}
\end{sphinxVerbatim}

This code snippet should run after all \sphinxtitleref{admin.py} files are loaded so that auto registration happends after all manually added models are registered. Django provides AppConfig.ready() to perform any initialization tasks which can be used to hook this code.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} file: library/book/apps.py}

\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}\PYG{p}{,} \PYG{n}{AppConfig}
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}


\PYG{k}{class} \PYG{n+nc}{BookAppConfig}\PYG{p}{(}\PYG{n}{AppConfig}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf}{ready}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{)}
            \PYG{k}{except} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{sites}\PYG{o}{.}\PYG{n}{AlreadyRegistered}\PYG{p}{:}
                \PYG{k}{pass}
\end{sphinxVerbatim}

In the admin, we can see manually registered models and automatically registered models. If we open admin page for any auto registered model, it will show something like this.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-auto-register2}.png}\hspace*{\fill}}

This view is not at all useful for the users who want to see the data. It will be more informative if we can show all the fields of the model in admin.


\section{Auto Registration With Fields}
\label{\detokenize{admin_auto_register_models:auto-registration-with-fields}}
To achieve that, we can create an admin class to populate model fields in \sphinxtitleref{list\_display}. While registering, we can use this admin class to register the model.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.apps} \PYG{k+kn}{import} \PYG{n}{apps}\PYG{p}{,} \PYG{n}{AppConfig}
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}


\PYG{k}{class} \PYG{n+nc}{ListModelAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{model}\PYG{p}{,} \PYG{n}{admin\PYGZus{}site}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{[}\PYG{n}{field}\PYG{o}{.}\PYG{n}{name} \PYG{k}{for} \PYG{n}{field} \PYG{o+ow}{in} \PYG{n}{model}\PYG{o}{.}\PYG{n}{\PYGZus{}meta}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{]}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{admin\PYGZus{}site}\PYG{p}{)}


\PYG{k}{class} \PYG{n+nc}{BookAppConfig}\PYG{p}{(}\PYG{n}{AppConfig}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf}{ready}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{models} \PYG{o}{=} \PYG{n}{apps}\PYG{o}{.}\PYG{n}{get\PYGZus{}models}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{model} \PYG{o+ow}{in} \PYG{n}{models}\PYG{p}{:}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{model}\PYG{p}{,} \PYG{n}{ListModelAdmin}\PYG{p}{)}
            \PYG{k}{except} \PYG{n}{admin}\PYG{o}{.}\PYG{n}{sites}\PYG{o}{.}\PYG{n}{AlreadyRegistered}\PYG{p}{:}
                \PYG{k}{pass}
\end{sphinxVerbatim}

Now, if we look at Author admin page, it will be shown with all relevant fields.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-auto-register3}.png}\hspace*{\fill}}

Since we have auto registration in place, when a new model is added or columns are altered for existing models, admin interface will update accordingly without any code changes.


\chapter{Custom Admin Actions For Querysets \& Individual Objects}
\label{\detokenize{admin_custom_admin_actions:custom-admin-actions-for-querysets-individual-objects}}\label{\detokenize{admin_custom_admin_actions::doc}}

\section{Custom Actions On Querysets}
\label{\detokenize{admin_custom_admin_actions:custom-actions-on-querysets}}
Django provides admin actions which work on a queryset level. By default, django provides delete action in the admin.

In our books admin, we can select a bunch of books and delete them.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-custom-actions1}.png}\hspace*{\fill}}

Django provides an option to hook user defined actions to run additional actions on selected items. Let us write write a custom admin action to mark selected books as available.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{actions} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{make\PYGZus{}books\PYGZus{}available}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{p}{)}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{make\PYGZus{}books\PYGZus{}available}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{modeladmin}\PYG{p}{,} \PYG{n}{request}\PYG{p}{,} \PYG{n}{queryset}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{queryset}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{is\PYGZus{}available}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{make\PYGZus{}books\PYGZus{}available}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mark selected books as available}\PYG{l+s+s2}{\PYGZdq{}}
\end{sphinxVerbatim}

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-custom-actions2}.png}\hspace*{\fill}}


\section{Custom Actions On Individual Objects}
\label{\detokenize{admin_custom_admin_actions:custom-actions-on-individual-objects}}
Custom admin actions are inefficient when taking action on an individual object. For example, to delete a single user, we need to follow these steps.
\begin{enumerate}
\def\theenumi{\arabic{enumi}}
\def\labelenumi{\theenumi .}
\makeatletter\def\p@enumii{\p@enumi \theenumi .}\makeatother
\item {} 
Select the checkbox of the object.

\item {} 
Click on the action dropdown.

\item {} 
Select “Delete selected” action.

\item {} 
Click on Go button.

\item {} 
Confirm that the objects needs to be deleted.

\end{enumerate}

Just to delete a single record, we have to perform 5 clicks. That’s too many clicks for a single action.

To simplify the process, we can have delete button at row level. This can be achieved by writing a function which will insert delete button for every record.

ModelAdmin instance provides a set of named URLs for CRUD operations. To get object url for a page, URL name will be \sphinxtitleref{\{\{ app\_label \}\}\_\{\{ model\_name \}\}\_\{\{ page \}\}}.

For example, to get delete URL of a book object, we can call \sphinxtitleref{reverse(“admin:book\_book\_delete”, args={[}book\_id{]})}. We can add a delete button with this link and add it to list\_display so that delete button is available for individual objects.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}
\PYG{k+kn}{from} \PYG{n+nn}{django.utils.html} \PYG{k+kn}{import} \PYG{n}{format\PYGZus{}html}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{Book}


\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{is\PYGZus{}available}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{delete}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{delete}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{view\PYGZus{}name} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{admin:\PYGZob{}\PYGZcb{}\PYGZus{}\PYGZob{}\PYGZcb{}\PYGZus{}delete}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{obj}\PYG{o}{.}\PYG{n}{\PYGZus{}meta}\PYG{o}{.}\PYG{n}{app\PYGZus{}label}\PYG{p}{,} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{\PYGZus{}meta}\PYG{o}{.}\PYG{n}{model\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{link} \PYG{o}{=} \PYG{n}{reverse}\PYG{p}{(}\PYG{n}{view\PYGZus{}name}\PYG{p}{,} \PYG{n}{args}\PYG{o}{=}\PYG{p}{[}\PYG{n}{book}\PYG{o}{.}\PYG{n}{pk}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{html} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}input type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{button}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ onclick=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{location.href=}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+s1}{\PYGZob{}\PYGZcb{}}\PYG{l+s+se}{\PYGZbs{}\PYGZsq{}}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{Delete}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{link}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{format\PYGZus{}html}\PYG{p}{(}\PYG{n}{html}\PYG{p}{)}
\end{sphinxVerbatim}

Now in the admin interface, we have delete button for individual objects.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{admin-custom-actions3}.png}\hspace*{\fill}}

To delete an object, just click on delete button and then confirm to delete it. Now, we are deleting objects with just 2 clicks.

In the above example, we have used an inbuilt model admin delete view. We can also write custom view and link those views for custom actions on individual objects. For example, we can add a button which will mark the book status to available.

In this chapter, we have seen how to write custom admin actions which work on single item as well as bulk items.


\chapter{Hyperlink Foreignkeys To Its Change View In Admin}
\label{\detokenize{admin_hyperlink_foreignkey:hyperlink-foreignkeys-to-its-change-view-in-admin}}\label{\detokenize{admin_hyperlink_foreignkey::doc}}
Consider Book model which has Author as foreignkey.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.db} \PYG{k+kn}{import} \PYG{n}{models}


\PYG{k}{class} \PYG{n+nc}{Author}\PYG{p}{(}\PYG{n}{models}\PYG{o}{.}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{name} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Book}\PYG{p}{(}\PYG{n}{models}\PYG{o}{.}\PYG{n}{Model}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{title} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
    \PYG{n}{author} \PYG{o}{=} \PYG{n}{models}\PYG{o}{.}\PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{Author}\PYG{p}{)}
\end{sphinxVerbatim}

We can register these models with admin interface as follows.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{.models} \PYG{k+kn}{import} \PYG{n}{Author}\PYG{p}{,} \PYG{n}{Book}

\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Author}\PYG{p}{)}
\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Book}\PYG{p}{,} \PYG{n}{BookAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

Once they are registered, admin page shows Book model like this.

\noindent{\hspace*{\fill}\sphinxincludegraphics{{django-admin-fk-link-1}.png}\hspace*{\fill}}

While browsing books, we can see book name and author name. Here, book name field is liked to book change view. But author field is shown as plain text.

If we have to modify author name, we have to go back to authors admin page, search for relevant author and then change name.

This becomes tedious if users spend lot of time in admin for tasks like this. Instead, if author field is hyperlinked to author change view, we can directly go to that page and change the name.

Django provides an option to access admin views by its URL reversing system. For example, we can get change view of author model in book app using reverse(“admin:book\_author\_change”, args=id). Now we can use this url to hyperlink author field in book admin.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}
\PYG{k+kn}{from} \PYG{n+nn}{django.utils.safestring} \PYG{k+kn}{import} \PYG{n}{mark\PYGZus{}safe}


\PYG{k}{class} \PYG{n+nc}{BookAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author\PYGZus{}link}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{author\PYGZus{}link}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{book}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{url} \PYG{o}{=} \PYG{n}{reverse}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{admin:book\PYGZus{}author\PYGZus{}change}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{args}\PYG{o}{=}\PYG{p}{[}\PYG{n}{book}\PYG{o}{.}\PYG{n}{author}\PYG{o}{.}\PYG{n}{id}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{link} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}a href=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{\PYGZgt{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+s1}{\PYGZlt{}/a\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n}{book}\PYG{o}{.}\PYG{n}{author}\PYG{o}{.}\PYG{n}{name}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{mark\PYGZus{}safe}\PYG{p}{(}\PYG{n}{link}\PYG{p}{)}
    \PYG{n}{author\PYGZus{}link}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Author}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Now in the book admin view, author field will be hyperlinked to its change view and we can visit just by clicking it.

Depending on requirements, we can link any field in django to other fields or add custom fields to improve productivity of users in admin.

Custom hyper links

\sphinxurl{https://docs.djangoproject.com/en/dev/ref/models/instances/\#get-absolute-url}


\chapter{Allow ForeignKey Fields In Admin List Display}
\label{\detokenize{admin_list_display_foreignkey:allow-foreignkey-fields-in-admin-list-display}}\label{\detokenize{admin_list_display_foreignkey::doc}}
Django admin has \sphinxtitleref{ModelAdmin} class which provides options and functionality for the models in admin interface. It has options like \sphinxtitleref{list\_display}, \sphinxtitleref{list\_filter}, \sphinxtitleref{search\_fields} to specify fields for corresponding actions.

\sphinxtitleref{search\_fields}, \sphinxtitleref{list\_filter} and other options allow to include a ForeignKey or ManyToMany field with lookup API follow notation. For example, to search by book name in Bestselleradmin, we can specify \sphinxtitleref{book\_\_name} in search fields.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{BestSeller}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{search\PYGZus{}fields} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Bestseller}\PYG{p}{,} \PYG{n}{BestsellerAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

However Django doesn’t allow the same follow notation in \sphinxtitleref{list\_display}. To include ForeignKey field or ManyToMany field in the list display, we have to write a custom method and add this method in list display.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{django.contrib} \PYG{k+kn}{import} \PYG{n}{admin}

\PYG{k+kn}{from} \PYG{n+nn}{book.models} \PYG{k+kn}{import} \PYG{n}{BestSeller}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{search\PYGZus{}fields} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{author}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{book}\PYG{o}{.}\PYG{n}{author}
    \PYG{n}{author}\PYG{o}{.}\PYG{n}{description} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Author}\PYG{l+s+s1}{\PYGZsq{}}


\PYG{n}{admin}\PYG{o}{.}\PYG{n}{site}\PYG{o}{.}\PYG{n}{register}\PYG{p}{(}\PYG{n}{Bestseller}\PYG{p}{,} \PYG{n}{BestsellerAdmin}\PYG{p}{)}
\end{sphinxVerbatim}

This way of adding foreignkeys in list\_display becomes tedious when there are lots of models with foreignkey fields.

We can write a custom admin class to dynamically set the methods as attributes so that we can use the ForeignKey fields in list\_display.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}related\PYGZus{}field}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{admin\PYGZus{}order\PYGZus{}field}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{short\PYGZus{}description}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{related\PYGZus{}names} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{dynamic\PYGZus{}attribute}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{related\PYGZus{}name} \PYG{o+ow}{in} \PYG{n}{related\PYGZus{}names}\PYG{p}{:}
            \PYG{n}{obj} \PYG{o}{=} \PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{,} \PYG{n}{related\PYGZus{}name}\PYG{p}{)}
            \PYG{k}{return} \PYG{n}{obj}

    \PYG{n}{dynamic\PYGZus{}attribute}\PYG{o}{.}\PYG{n}{admin\PYGZus{}order\PYGZus{}field} \PYG{o}{=} \PYG{n}{admin\PYGZus{}order\PYGZus{}field} \PYG{o+ow}{or} \PYG{n}{name}
    \PYG{n}{dynamic\PYGZus{}attribute}\PYG{o}{.}\PYG{n}{short\PYGZus{}description} \PYG{o}{=} \PYG{n}{short\PYGZus{}description} \PYG{o+ow}{or} \PYG{n}{related\PYGZus{}names}\PYG{p}{[}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{title}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{replace}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{dynamic\PYGZus{}attribute}


\PYG{k}{class} \PYG{n+nc}{RelatedFieldAdmin}\PYG{p}{(}\PYG{n}{admin}\PYG{o}{.}\PYG{n}{ModelAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}getattr\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}\PYGZus{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{attr}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{get\PYGZus{}related\PYGZus{}field}\PYG{p}{(}\PYG{n}{attr}\PYG{p}{)}

        \PYG{c+c1}{\PYGZsh{} not dynamic lookup, default behaviour}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}getattribute\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{attr}\PYG{p}{)}


\PYG{k}{class} \PYG{n+nc}{BestSellerAdmin}\PYG{p}{(}\PYG{n}{RelatedFieldAdmin}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{list\PYGZus{}display} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rank}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{year}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{book\PYGZus{}\PYGZus{}author}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

By sublcassing RelatedFieldAdmin, we can directly use foreignkey fields in list display.

However, this will lead to N+1 problem. We will discuss more about this and how to fix this in orm optimizations chapter.


\chapter{Django Migrations}
\label{\detokenize{orm_migrations:django-migrations}}\label{\detokenize{orm_migrations::doc}}

\section{Safe/Unsafe Migrations}
\label{\detokenize{orm_migrations:safe-unsafe-migrations}}

\subsection{test}
\label{\detokenize{orm_migrations:test}}

\section{Schema/Data Migrations}
\label{\detokenize{orm_migrations:schema-data-migrations}}
Mixing schema and data migrations

set constrainsts

split migrations


\chapter{Log SQL Queries To Console}
\label{\detokenize{orm_log_sql:log-sql-queries-to-console}}\label{\detokenize{orm_log_sql::doc}}
Django ORM makes easy to interact with database. To understand what is happening behing the scenes or to see SQL performance, we can log all the SQL queries that be being executed. In this article, we will see various ways to achieve this.


\section{Using debug-toolbar}
\label{\detokenize{orm_log_sql:using-debug-toolbar}}
Django debug toolbar provides panels to show debug information about requests. It has SQL panel which shows all executed SQL queries and time taken for them.

When building REST APIs or micro services where django templating engine is not used, this method won’t work. In these situations, we have to log SQL queries to console.


\section{Using django-extensions}
\label{\detokenize{orm_log_sql:using-django-extensions}}
Django-extensions provides lot of utilities for productive development. For runserver\_plus and shell\_plus commands, it accepts and optional \textendash{}print-sql argument, which prints all the SQL queries that are being executed.

./manage.py runserver\_plus \textendash{}print-sql
./manage.py shell\_plus \textendash{}print-sql
Whenever an SQL query gets executed, it prints the query and time taken for it in console.

In {[}42{]}: User.objects.filter(is\_staff=True)
Out{[}42{]}: SELECT “auth\_user”.”id”,
\begin{quote}
\begin{quote}
\begin{quote}

“auth\_user”.”password”,
“auth\_user”.”last\_login”,
“auth\_user”.”is\_superuser”,
“auth\_user”.”username”,
“auth\_user”.”first\_name”,
“auth\_user”.”last\_name”,
“auth\_user”.”email”,
“auth\_user”.”is\_staff”,
“auth\_user”.”is\_active”,
“auth\_user”.”date\_joined”
\end{quote}

FROM “auth\_user”
\end{quote}

WHERE “auth\_user”.”is\_staff” = true
LIMIT 21
\end{quote}

Execution time: 0.002107s {[}Database: default{]}

\textless{}QuerySet {[}\textless{}User: anand\textgreater{}, \textless{}User: chillar\textgreater{}{]}\textgreater{}
Using django-querycount
Django-querycount provides a middleware to show SQL query count and show duplicate queries on console.

{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
\textbar{} Type \textbar{} Database  \textbar{}   Reads  \textbar{}  Writes  \textbar{}  Totals  \textbar{} Duplicates \textbar{}
{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
\textbar{} RESP \textbar{}  default  \textbar{}    3     \textbar{}    0     \textbar{}    3     \textbar{}     1      \textbar{}
{\color{red}\bfseries{}\textbar{}------\textbar{}}———\textendash{}{\color{red}\bfseries{}\textbar{}----------\textbar{}}———-{\color{red}\bfseries{}\textbar{}----------\textbar{}}————\textbar{}
Total queries: 3 in 1.7738s

Repeated 1 times.
SELECT “django\_session”.”session\_key”,
“django\_session”.”session\_data”, “django\_session”.”expire\_date” FROM
“django\_session” WHERE (“django\_session”.”session\_key” =
‘dummy\_key AND “django\_session”.”expire\_date”
\textgreater{} ‘2018-05-31T09:38:56.369469+00:00’::timestamptz)
This package provides additional settings to customize output.

Django logging
Instead of using any 3rd party package, we can use django.db.backends logger to print all the SQL queries.

Add django.db.backends to loggers list and set log level and handlers.
\begin{quote}
\begin{description}
\item[{‘loggers’: \{}] \leavevmode\begin{description}
\item[{‘django.db.backends’: \{}] \leavevmode
‘level’: ‘DEBUG’,
‘handlers’: {[}‘console’, {]},

\end{description}

\},

\end{description}
\end{quote}

In runserver console, we can see all SQL queries that are being executed.

(0.001) SELECT “django\_admin\_log”.”id”, “django\_admin\_log”.”action\_time”, “django\_admin\_log”.”user\_id”, “django\_admin\_log”.”content\_type\_id”, “django\_admin\_log”.”object\_id”, “django\_admin\_log”.”object\_repr”, “django\_admin\_log”.”action\_flag”, “django\_admin\_log”.”change\_message”, “auth\_user”.”id”, “auth\_user”.”password”, “auth\_user”.”last\_login”, “auth\_user”.”is\_superuser”, “auth\_user”.”username”, “auth\_user”.”first\_name”, “auth\_user”.”last\_name”, “auth\_user”.”email”, “auth\_user”.”is\_staff”, “auth\_user”.”is\_active”, “auth\_user”.”date\_joined”, “django\_content\_type”.”id”, “django\_content\_type”.”app\_label”, “django\_content\_type”.”model” FROM “django\_admin\_log” INNER JOIN “auth\_user” ON (“django\_admin\_log”.”user\_id” = “auth\_user”.”id”) LEFT OUTER JOIN “django\_content\_type” ON (“django\_admin\_log”.”content\_type\_id” = “django\_content\_type”.”id”) WHERE “django\_admin\_log”.”user\_id” = 4 ORDER BY “django\_admin\_log”.”action\_time” DESC LIMIT 10; args=(4,)
{[}2018/06/03 15:06:59{]} HTTP GET /admin/ 200 {[}1.69, 127.0.0.1:47734{]}
These are few ways to log all SQL queries to console. We can also write a custom middleware for better logging of these queries and get some insights.


\chapter{ORM Gotchas}
\label{\detokenize{orm_optimizations:orm-gotchas}}\label{\detokenize{orm_optimizations::doc}}
N+1 Queries


\section{Caching}
\label{\detokenize{orm_optimizations:caching}}

\section{Eager evaluation}
\label{\detokenize{orm_optimizations:eager-evaluation}}

\section{Lazy evaluation}
\label{\detokenize{orm_optimizations:lazy-evaluation}}
book.author.id
book.author\_id

qs.exist()

.iterator()

bulk operations
\begin{description}
\item[{bulk update wont call save or signals}] \leavevmode
Runpython wont call these

\end{description}

get only what you need

values\_list()

enable query logging


\chapter{Form with multiple submit buttons}
\label{\detokenize{forms_multi_submit:form-with-multiple-submit-buttons}}\label{\detokenize{forms_multi_submit::doc}}
submit1

submit2


\chapter{Dealing With CSRF Token Outside Of Django}
\label{\detokenize{misc_csrf_token:dealing-with-csrf-token-outside-of-django}}\label{\detokenize{misc_csrf_token::doc}}

\section{Ajax}
\label{\detokenize{misc_csrf_token:ajax}}
When making ajax calls from browser, we need to set CSRF token.


\section{Postman}
\label{\detokenize{misc_csrf_token:postman}}
Django has inbuilt CSRF protection mechanism for requests via unsafe methods to prevent Cross Site Request Forgeries. When CSRF protection is enabled on AJAX POST methods, X-CSRFToken header should be sent in the request.

Postman is one of the widely used tool for testing APIs. In this article, we will see how to set csrf token and update it automatically in Postman.
CSRF Token In Postman

Django sets csrftoken cookie on login. After logging in, we can see the csrf token from cookies in the Postman.

We can grab this token and set it in headers manually.

But this token has to be manually changed when it expires. This process becomes tedious to do it on an expiration basis.

Instead, we can use Postman scripting feature to extract token from cookie and set it to an environment variable. In Test section of postman, add these lines.

var xsrfCookie = postman.getResponseCookie(“csrftoken”);
postman.setEnvironmentVariable(‘csrftoken’, xsrfCookie.value);

This extracts csrf token and sets it to an evironment variable called csrftoken in the current environment.

Now in our requests, we can use this variable to set the header.

When the token expires, we just need to login again and csrf token gets updated automatically.
Conclusion

In this article we have seen how to set and renew csrftoken automatically in Postman. We can follow similar techniques on other API clients like CURL or httpie to set csrf token.


\section{Shell}
\label{\detokenize{misc_csrf_token:shell}}
HTTPie is an alternative to curl for interacting with web services from CLI. It provides a simple and intuitive interface and it is handy to send arbitrary HTTP requests while testing/debugging APIs.

When working with web applications that require authentication, using httpie is difficult as authentication mechanism will be different for different applications. httpie has in built support for basic \& digest authentication.

To authenticate with Django apps, a user needs to make a GET request to login page. Django sends login form with a CSRF token. User can submit this form with valid credentials and a session will be initiated.

Establish session manually is boring and it gets tedious when working with multiple apps in multiple environments(development, staging, production).

I have written a plugin called httpie-django-auth which automates django authentication. It can be installed with pip

pip install httpie-django-auth

By default, it uses /admin/login to login. If you need to use some other URL for logging, set HTTPIE\_DJANGO\_AUTH\_URL environment variable.

export HTTPIE\_DJANGO\_AUTH\_URL=’/accounts/login/’

Now you can send authenticated requests to any URL as

http :8000/profile -A=django \textendash{}auth=’username:password’

paas

iaas

ec2

home


\chapter{Laziness \& Caching}
\label{\detokenize{misc_eager_lazy:laziness-caching}}\label{\detokenize{misc_eager_lazy::doc}}

\chapter{Dynamic Initial Values In Forms}
\label{\detokenize{misc_gotcha_initial:dynamic-initial-values-in-forms}}\label{\detokenize{misc_gotcha_initial::doc}}
Django form fields accept initial argument. So You can set a default value for a field.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{SampleForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}     \PYG{n}{name} \PYG{o}{=} \PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{initial}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{avil page}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f} \PYG{o}{=} \PYG{n}{SampleForm}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+sa}{u}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{avil page}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Sometimes it is required to override init method in forms and set field initial arguments.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{initial} \PYG{o}{=}  \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f2} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f2}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{14}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Now let’s pass some initial data to form and see what happens.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{initial} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} don\PYGZsq{}t try this at home}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{19}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f3} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{n}{initial}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f3}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

If You look at the value of input field, it’s is NOT the overrided. It still has form initial value!

If You look into source code of django forms to find what is happening, You will find this.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{data} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{field}\PYG{o}{.}\PYG{n}{bound\PYGZus{}data}\PYG{p}{(}
       \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data}\PYG{p}{,}
       \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{form}\PYG{o}{.}\PYG{n}{initial}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{field}\PYG{o}{.}\PYG{n}{initial}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} precedence matters!!!!}
\PYG{p}{)}
\end{sphinxVerbatim}

So form’s initial value has precedence over fields initial values.

So You have to override form’s initial value instead of fields’s initial value to make it work as expected.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{21}\PYG{p}{]}\PYG{p}{:} \PYG{k+kn}{from} \PYG{n+nn}{django} \PYG{k+kn}{import} \PYG{n}{forms}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{22}\PYG{p}{]}\PYG{p}{:} \PYG{k}{class} \PYG{n+nc}{AdvancedForm}\PYG{p}{(}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{Form}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}    \PYG{k}{def} \PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb}{super}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n+nf+fm}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{n}{args}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{initial}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZsq{}}  \PYG{c+c1}{\PYGZsh{} aha!!!!}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}        \PYG{n}{name}\PYG{o}{=}\PYG{n}{forms}\PYG{o}{.}\PYG{n}{CharField}\PYG{p}{(}\PYG{n}{max\PYGZus{}length}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
   \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{:}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{23}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f4} \PYG{o}{=} \PYG{n}{AdvancedForm}\PYG{p}{(}\PYG{n}{initial}\PYG{o}{=}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{precedence}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{In} \PYG{p}{[}\PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{:} \PYG{n}{f4}\PYG{o}{.}\PYG{n}{as\PYGZus{}p}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{Out}\PYG{p}{[}\PYG{l+m+mi}{24}\PYG{p}{]}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZlt{}p\PYGZgt{}Name: \PYGZlt{}input maxlength=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{10}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ name=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{name}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ type=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{text}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ value=}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{override}\PYG{l+s+s1}{\PYGZdq{}}\PYG{l+s+s1}{ /\PYGZgt{}\PYGZlt{}/p\PYGZgt{}}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

Management command
intial value

models initial value
dict=\{\}


\chapter{Management commands}
\label{\detokenize{misc_management_commands:management-commands}}\label{\detokenize{misc_management_commands::doc}}
ram
.iterator()

cpu
cron job
frequent restarts


\chapter{Profiling \& Optimizing Dango}
\label{\detokenize{misc_profiling:profiling-optimizing-dango}}\label{\detokenize{misc_profiling::doc}}

\section{What to Optimize?}
\label{\detokenize{misc_profiling:what-to-optimize}}
When optimizing performance of web application, a common mistake is to start with optimizing the slowest page(or API) or going after micro optimizations which are not worth the effort.

In addition to considering response time, we should also consider the traffic it is receving to priorotize the order of optimization.


\section{Metrics}
\label{\detokenize{misc_profiling:metrics}}
Let us profile our library django application and find performance bottlenecks.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
pip install django\PYGZhy{}silk
\end{sphinxVerbatim}

Add silk to installed apps and include silk middleware in django settings.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{MIDDLEWARE} \PYG{o}{=} \PYG{p}{[}
    \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{silk.middleware.SilkyMiddleware}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
    \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
\PYG{p}{]}

\PYG{n}{INSTALLED\PYGZus{}APPS} \PYG{o}{=} \PYG{p}{(}
    \PYG{o}{.}\PYG{o}{.}\PYG{o}{.}
    \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{silk}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{p}{)}
\end{sphinxVerbatim}

Run migrations so that Silk can create required database tables to store profile data.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZdl{} python manage.py makemigrations
\PYGZdl{} python manage.py migrate
\PYGZdl{} python manage.py collectstatic
\end{sphinxVerbatim}

Include silk urls in root urlconf to view the profile data.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{urlpatterns} \PYG{o}{+}\PYG{o}{=} \PYG{p}{[}\PYG{n}{url}\PYG{p}{(}\PYG{l+s+sa}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZca{}silk/}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{include}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{silk.urls}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{namespace}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{silk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}
\end{sphinxVerbatim}

On silk requests page(\sphinxurl{http://host/silk/requests/}), we can see all requests and sort them by overall time or time spent in database.

Silk creates silk\_request table which contains information about the requests processed by django.

In this article, we learnt how to profile django webapp and identify bottlenecks to improve performance. In the next article, we wil learn how to optimize these bottlenecks by taking an in-depth look at them.


\section{Aggregration}
\label{\detokenize{misc_profiling:aggregration}}
Silk doesn’t have support for aggregration of metrics and showing show overall picture of the collected data on a dashboard.

We can write an admin view to show a dashboard of the metrics.


\section{Profiling}
\label{\detokenize{misc_profiling:profiling}}
./manage.py runcprofileserver


\section{Optimizing For Performance}
\label{\detokenize{misc_profiling:optimizing-for-performance}}

\chapter{Appendix A}
\label{\detokenize{appendix:appendix-a}}\label{\detokenize{appendix::doc}}

\section{Shell}
\label{\detokenize{appendix:shell}}
zsh/fish

aliases

auto completion

Developers and hackers prefer using terminal and spend a lot of time on it. Instead of typing long commands over and over, they can be aliased to shortnames. The shell builtin alias allows users to set aliases.

One of the most used command while setting up development environment is pip install -r requirements.txt This can be aliased to pir.

alias pir=’pip install -r requirements.txt
Now to install requirements, type pir and pressing enter. Here are some other aliases related to python which will be useful on a daily basis.

alias py=’python’
alias ipy=’ipython’
alias py3=’python3’
alias ipy3=’ipython3’

alias jn=’jupyter notebook’

alias wo=’workon’
alias pf=’pip freeze \textbar{} sort’
alias pi=’pip install’
alias pun=’pip uninstall’

alias dj=”python manage.py”
alias drs=”python manage.py runserver”
alias drp=”python manage.py runserverplus”
alias dsh=”python manage.py shell”
alias dsp=”python manage.py shell\_plus”
alias dsm=”python manage.py schemamigration”
alias dm=”python manage.py migrate”
alias dmm=”python manage.py makemigrations”
alias ddd=”python manage.py dumpdata”
alias dld=”python manage.py loaddata”
alias dt=”python manage.py test”
Just add the above aliases to your \textasciitilde{}/.bashrc or \textasciitilde{}/.zshrc. That’s it. Hpy alsng!


\section{iPython}
\label{\detokenize{appendix:ipython}}
init file

auto reload



\renewcommand{\indexname}{Index}
\printindex
\end{document}